name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/aiqlick-meeting

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.image-info.outputs.tag }}
      commit-sha: ${{ steps.image-info.outputs.sha }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Set image info
        id: image-info
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "tag=latest" >> $GITHUB_OUTPUT
          echo "sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ steps.image-info.outputs.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            JITSI_WEB_TAG=stable-9823
            BUILD_VERSION=${{ steps.image-info.outputs.sha }}

  deploy-to-gitops:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'

    steps:
      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: AiQlickProject/aiqlick-gitops-infrastructure
          token: ${{ secrets.GITOPS_TOKEN }}
          path: gitops
          fetch-depth: 0
          persist-credentials: false

      - name: Install yq
        uses: mikefarah/yq@v4.35.2

      - name: Update GitOps values to trigger deployment
        run: |
          echo "üìÜ Generating unique timestamp..."
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")-$(uuidgen)

          echo "üîß Updating jitsi-meet values.yaml..."
          cd gitops/k8s/jitsi-meet

          # Update the web image to use custom image with 'latest' tag
          # Using 'latest' ensures Kubernetes pulls the newest image on restart
          yq eval '.jitsi-meet.web.image.repository = "${{ env.IMAGE_NAME }}"' -i values.yaml
          yq eval '.jitsi-meet.web.image.tag = "latest"' -i values.yaml

          # Add deployment annotation with timestamp to trigger pod restart
          # This ensures K8s detects a change even when using 'latest' tag
          yq eval '.jitsi-meet.web.podAnnotations = (.jitsi-meet.web.podAnnotations // {})' -i values.yaml
          yq eval ".jitsi-meet.web.podAnnotations[\"ci-last-updated\"] = \"$DATE\"" -i values.yaml
          yq eval ".jitsi-meet.web.podAnnotations[\"git-commit\"] = \"${{ needs.build-and-push.outputs.commit-sha }}\"" -i values.yaml

          echo "üìã Showing updated web image section:"
          yq eval '.jitsi-meet.web.image' values.yaml

      - name: Commit and push changes to GitOps repo
        working-directory: gitops
        run: |
          echo "üîê Configuring Git credentials"
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git remote set-url origin https://${{ secrets.GITOPS_TOKEN }}@github.com/AiQlickProject/aiqlick-gitops-infrastructure.git

          echo "üì• Staging updated values.yaml..."
          git add k8s/jitsi-meet/values.yaml

          if git diff --cached --quiet; then
            echo "‚úÖ No changes to commit."
          else
            DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            COMMIT_SHA="${{ needs.build-and-push.outputs.commit-sha }}"
            ACTOR="${{ github.actor }}"
            MSG="ci: deploy aiqlick-meeting commit ${COMMIT_SHA} (${DATE})"$'\n\n'"Automatic deployment triggered by CI"$'\n'"Image: aiqlick-meeting:$COMMIT_SHA"$'\n'"Commit: ${COMMIT_SHA}"$'\n'"Deployed by: ${ACTOR}"
            echo "üì§ Committing and pushing changes..."
            git commit -m "$MSG"
            git push origin main
            echo "‚úÖ Successfully pushed changes to trigger ArgoCD sync"
          fi

      - name: Deployment summary
        run: |
          echo "üéâ Deployment completed successfully!"
          echo "üìç Commit: ${{ needs.build-and-push.outputs.commit-sha }}"
          echo "üè∑Ô∏è  Image: ${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.commit-sha }}"
          echo "üë§ Deployed by: ${{ github.actor }}"
          echo "‚è∞ Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "‚úÖ Jitsi Meet web UI deployment initiated"
